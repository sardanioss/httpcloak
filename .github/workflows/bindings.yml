name: Build and Publish

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-native:
    name: Build native library (${{ matrix.os }}-${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: amd64
            runner: ubuntu-latest
            lib_ext: .so
            npm_platform: linux-x64
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm
            lib_ext: .so
            npm_platform: linux-arm64
          - os: darwin
            arch: amd64
            runner: macos-15-large
            lib_ext: .dylib
            npm_platform: darwin-x64
          - os: darwin
            arch: arm64
            runner: macos-14
            lib_ext: .dylib
            npm_platform: darwin-arm64
          - os: windows
            arch: amd64
            runner: windows-latest
            lib_ext: .dll
            npm_platform: win32-x64

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build native library (Unix)
        if: runner.os != 'Windows'
        run: |
          cd bindings/clib
          chmod +x build.sh
          ./build.sh native
        env:
          CGO_ENABLED: 1

      - name: Build native library (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          cd bindings/clib
          mkdir -p dist
          CGO_ENABLED=1 go build -buildmode=c-shared -ldflags="-s -w" -o dist/libhttpcloak-windows-amd64.dll httpcloak.go

      - name: Upload native library
        uses: actions/upload-artifact@v4
        with:
          name: lib-${{ matrix.os }}-${{ matrix.arch }}
          path: bindings/clib/dist/libhttpcloak-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.lib_ext }}

  build-python-wheels:
    name: Build Python wheel (${{ matrix.os }}-${{ matrix.arch }})
    needs: build-native
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: amd64
            runner: ubuntu-latest
            plat_tag: manylinux_2_17_x86_64
            lib_ext: .so
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm
            plat_tag: manylinux_2_17_aarch64
            lib_ext: .so
          - os: darwin
            arch: amd64
            runner: macos-15-large
            plat_tag: macosx_10_9_x86_64
            lib_ext: .dylib
          - os: darwin
            arch: arm64
            runner: macos-14
            plat_tag: macosx_11_0_arm64
            lib_ext: .dylib
          - os: windows
            arch: amd64
            runner: windows-latest
            plat_tag: win_amd64
            lib_ext: .dll

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download native library
        uses: actions/download-artifact@v4
        with:
          name: lib-${{ matrix.os }}-${{ matrix.arch }}
          path: bindings/python/httpcloak/lib/

      - name: Build wheel
        run: |
          cd bindings/python
          pip install build wheel
          python -m build --wheel

      - name: Rename wheel with platform tag
        shell: bash
        run: |
          cd bindings/python/dist
          for f in *.whl; do
            newname=$(echo "$f" | sed 's/-py3-none-any/-py3-none-${{ matrix.plat_tag }}/')
            mv "$f" "$newname"
          done

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.os }}-${{ matrix.arch }}
          path: bindings/python/dist/*.whl

  build-npm-platform-packages:
    name: Build npm platform package (${{ matrix.npm_platform }})
    needs: build-native
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: amd64
            npm_platform: linux-x64
            lib_name: libhttpcloak-linux-amd64.so
          - os: linux
            arch: arm64
            npm_platform: linux-arm64
            lib_name: libhttpcloak-linux-arm64.so
          - os: darwin
            arch: amd64
            npm_platform: darwin-x64
            lib_name: libhttpcloak-darwin-amd64.dylib
          - os: darwin
            arch: arm64
            npm_platform: darwin-arm64
            lib_name: libhttpcloak-darwin-arm64.dylib
          - os: windows
            arch: amd64
            npm_platform: win32-x64
            lib_name: libhttpcloak-windows-amd64.dll

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Download native library
        uses: actions/download-artifact@v4
        with:
          name: lib-${{ matrix.os }}-${{ matrix.arch }}
          path: bindings/nodejs/npm/${{ matrix.npm_platform }}/

      - name: Upload platform package
        uses: actions/upload-artifact@v4
        with:
          name: npm-platform-${{ matrix.npm_platform }}
          path: bindings/nodejs/npm/${{ matrix.npm_platform }}/

  test-nodejs:
    name: Test Node.js (${{ matrix.os }}-${{ matrix.arch }})
    needs: build-native
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: amd64
            runner: ubuntu-latest
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm
          - os: darwin
            arch: amd64
            runner: macos-15-large
          - os: darwin
            arch: arm64
            runner: macos-14
          - os: windows
            arch: amd64
            runner: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download native library
        uses: actions/download-artifact@v4
        with:
          name: lib-${{ matrix.os }}-${{ matrix.arch }}
          path: bindings/nodejs/lib/

      - name: Install dependencies
        run: |
          cd bindings/nodejs
          npm install --ignore-scripts

      - name: Test
        run: |
          cd bindings/nodejs
          node test.js

  publish-pypi:
    name: Publish to PyPI
    needs: build-python-wheels
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    environment: pypi
    permissions:
      id-token: write

    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheel-*
          path: dist/
          merge-multiple: true

      - name: List wheels
        run: ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

  publish-npm-platforms:
    name: Publish npm platform packages
    needs: [build-npm-platform-packages, test-nodejs]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    environment: npm
    strategy:
      fail-fast: false
      matrix:
        npm_platform: [linux-x64, linux-arm64, darwin-x64, darwin-arm64, win32-x64]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Download platform package
        uses: actions/download-artifact@v4
        with:
          name: npm-platform-${{ matrix.npm_platform }}
          path: bindings/nodejs/npm/${{ matrix.npm_platform }}/

      - name: Publish platform package
        run: |
          cd bindings/nodejs/npm/${{ matrix.npm_platform }}
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-npm-main:
    name: Publish main npm package
    needs: publish-npm-platforms
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    environment: npm

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Publish main package
        run: |
          cd bindings/nodejs
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
